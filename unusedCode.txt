#include <poll.h>

bool FifoRunnable::waitRequest() {
  unsigned rep = 0;
  do {
    errno = 0;
    pollfd pfd{ _fdRead, POLLIN, -1 };
    int presult = poll(&pfd, 1, -1);
    if (presult <= 0) {
      std::cerr << __FILE__ << ':' << __LINE__ << ' ' << __func__
		<< '-' << std::strerror(errno) << std::endl;
      if (errno == EINTR)
	continue;
      return false;
    }
    else if (pfd.revents & POLLERR) {
      std::cerr << __FILE__ << ':' << __LINE__ << ' ' << __func__
		<< '-' << std::strerror(errno) << std::endl;
      return false;
    }
    else if (pfd.revents & POLLHUP) {
      if (!_stopFlag)
	std::cerr << __FILE__ << ':' << __LINE__ << ' ' << __func__
		  << ":POLLHUP detected " << _receiveFifoName << std::endl;
      close(_fdRead);
      _fdRead = -1;
      close(_fdWrite);
      _fdWrite = -1;
      return false;
    }
  } while (errno == EINTR && rep++ < 3 && !_stopFlag);
  return !_stopFlag;
}
